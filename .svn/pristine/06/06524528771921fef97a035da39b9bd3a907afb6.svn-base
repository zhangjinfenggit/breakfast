package com.hmw.open.web.app;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import javax.annotation.Resource;
import javax.servlet.http.HttpServletRequest;

import org.apache.commons.lang3.StringUtils;
import org.apache.log4j.Logger;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.ResponseBody;

import com.baomidou.mybatisplus.mapper.EntityWrapper;
import com.baomidou.mybatisplus.mapper.Wrapper;
import com.baomidou.mybatisplus.plugins.Page;
import com.baomidou.mybatisplus.plugins.pagination.Pagination;
import com.hmw.open.common.result.BaseResult;
import com.hmw.open.model.BfBusinessRecordDay;
import com.hmw.open.model.BfOrder;
import com.hmw.open.model.BfShop;
import com.hmw.open.model.BfSubwayLine;
import com.hmw.open.model.UserBaseInfoVo;
import com.hmw.open.service.IBfBusinessRecordDayService;
import com.hmw.open.service.IBfOrderService;
import com.hmw.open.service.IBfShopService;
import com.hmw.open.service.IBfSubwayLineService;
import com.hmw.open.service.impl.CacheServiceImpl;
import com.hmw.open.web.app.response.bussinesscontroller.TransferRecord;
import com.hmw.open.web.weixin.request.shopcontroller.SubwayRequest;
import com.hmw.open.web.weixin.response.shopcontroller.QueryShop;

@Controller
@RequestMapping("/app")
public class AppBussinessController {
	
	private final static Logger logger = Logger.getLogger(AppBussinessController.class);
	
	@Autowired	
	IBfBusinessRecordDayService bfBusinessRecordDayService;
	
	@Autowired		
	IBfOrderService bfOrderService;
	
	@Resource
	private CacheServiceImpl cacheService;
	
	
	@RequestMapping(value = { "/transferRecord" }, method = { RequestMethod.POST })
	public @ResponseBody BaseResult transferRecord(HttpServletRequest request) {
		try {
			BaseResult baseResult = BaseResult.success();
			
			UserBaseInfoVo user = cacheService.getUserInfoJsonFromCache(request);
			
			//获取转账记录
			List<BfBusinessRecordDay> records =  new ArrayList();
			Wrapper<BfBusinessRecordDay> wrapper = new EntityWrapper<BfBusinessRecordDay>();
			wrapper.eq("shop_id", user.getShopId());
			wrapper.orderBy("transfer_time",true);
			records = bfBusinessRecordDayService.selectList(wrapper);
			
			
			//获取未转账记录,这个地方是自定义sql，并示例自定义sql分页

			BfOrder examplebBOrder= new BfOrder();
			Page<BfOrder> page= new Page<BfOrder>(1, 1000000);
			int untranferedMoney=bfOrderService.selectUntranferedMoney(page, examplebBOrder);
			
			
			
			
			//对转账记录进行转换，过滤不需要的字段
			List<TransferRecord> transfered=new ArrayList();
			for(BfBusinessRecordDay record:records){
				TransferRecord tf=new TransferRecord();
				tf.setTransferTime(record.getTransferTime());
				tf.setTransferMoney(record.getTransferMoney());
				transfered.add(tf);
			}
			
			//组装结果
			Map resultMap = new HashMap();
			resultMap.put("transfered", transfered);
			resultMap.put("untranferedMoney", untranferedMoney);

			baseResult.setData(resultMap);
			return baseResult;
		} catch (Exception e) {
			logger.error("error:", e);
			return BaseResult.exception(e.getMessage());
		}
	}
	
	
	


}
