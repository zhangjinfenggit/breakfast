package com.hmw.open.service.impl;

import java.math.BigDecimal;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import javax.annotation.Resource;

import org.apache.log4j.Logger;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.stereotype.Service;

import com.alibaba.fastjson.JSON;
import com.baomidou.mybatisplus.mapper.EntityWrapper;
import com.hmw.open.common.constants.BusinessRecordErrorCode;
import com.hmw.open.common.constants.Constant;
import com.hmw.open.common.result.BaseResult;
import com.hmw.open.common.result.ErrorCode;
import com.hmw.open.common.utils.DateUtils;
import com.hmw.open.mapper.BfBusinessRecordDayMapper;
import com.hmw.open.mapper.BfOrderDetailMapper;
import com.hmw.open.mapper.BfOrderMapper;
import com.hmw.open.mapper.BfShopMapper;
import com.hmw.open.model.BfBusinessRecordDayVo;
import com.hmw.open.model.BfOrderVo;
import com.hmw.open.model.BfOrderVos;
import com.hmw.open.model.BfOrdersVo;
import com.hmw.open.model.BfShop;
import com.hmw.open.model.HistroySumRecordVo;
import com.hmw.open.model.UserBaseInfoVo;
import com.hmw.open.web.app.request.bussinesscontroller.BusinessRecordDetailRequest;
import com.hmw.open.web.app.request.bussinesscontroller.OrderListRequest;

@Service
public class AppBusinessRecordServiceImpl {

	private final static Logger logger = Logger.getLogger(AppBusinessRecordServiceImpl.class);

	@Resource
	RedisTemplate<String, String> redisTemplate;

	@Autowired
	BfOrderDetailMapper bfOrderDetailMapper;

	@Autowired
	BfBusinessRecordDayMapper bfBusinessRecordDayMapper;

	@Autowired
	BfOrderMapper bfOrderMapper;

	@Autowired
	BfShopMapper bfShopMapper;

	@Autowired
	CacheServiceImpl cacheService;

	/**
	 * 通过token获取商家的信息，然后通过传入当天的时间来获取今日的流水
	 * @param businessRecord
	 * @return
	 */
	public BaseResult merchantSelectRefundRecord(UserBaseInfoVo userVo) throws Exception {
		BaseResult baseResult = null;
		Map<String, Object> map = new HashMap<>();

		String phone = userVo.getPhone();

		BfShop selectShop = new BfShop();
		selectShop.setPhone(phone);
		// 查询商店
		BfShop shop = bfShopMapper.selectOne(selectShop);

		if (null == shop) {
			return BaseResult.fail(ErrorCode.NullPointerExceptionRetInfo, ErrorCode.NullPointerExceptionRetCode);
		}

		// 商店Id
		Long shopId = shop.getId();
		// 获得当天的流水记录（逆序显示）
		List<BfOrderVo> orderList = bfOrderMapper.selectNowDayDetail(new EntityWrapper<Object>().eq("shop_id", shopId).ge("order_time", DateUtils.morning(new Date())).orderBy("id", false));
		// 表示当前订单为空
		if(null == orderList ){
			logger.error(BusinessRecordErrorCode.ORDER_ISEMPTY + "，当前订单为：" + JSON.toJSONString(orderList), null);
			return BaseResult.fail(ErrorCode.IsNullRetInfo, ErrorCode.IsNullRetCode);
		}else{
			// 放入查询到的数据
			map.put("orderList", orderList);

			baseResult = BaseResult.success();
			// 返回查询的信息
			baseResult.setData(map);

			return baseResult;
		}

	}


	/**
	 * 通过
	 * 
	 * @param totalBusinessRecordRequest
	 * @return
	 * @throws Exception
	 */
	public BaseResult getTotalBusinessRecord(UserBaseInfoVo userVo) throws Exception {
		// 初始化为0
		BigDecimal historySumIncome = new BigDecimal(0); // 总收入
		BigDecimal historySumRefund = new BigDecimal(0);// 退款
		BigDecimal historySumPartion = new BigDecimal(0); // 平台
		BigDecimal total = new BigDecimal(0); // 合计

		BaseResult baseResult = null;
		Map<String, Object> map = new HashMap<>();

		String phone = userVo.getPhone();

		BfShop selectShop = new BfShop();
		selectShop.setPhone(phone);

		BfShop shop = bfShopMapper.selectOne(selectShop);
		if (shop == null) {
			logger.error(ErrorCode.IsNullRetCode + "，当前商店为：" + JSON.toJSONString(shop), null);
			return BaseResult.fail(ErrorCode.NullPointerExceptionRetInfo, ErrorCode.NullPointerExceptionRetCode);
		}
		Long shopId = shop.getId();
		// 未退款
		BfBusinessRecordDayVo incomeAndNotRecord = bfBusinessRecordDayMapper//
				.getIncomeAndNotRefund(new EntityWrapper<Integer>().eq("shop_id", shopId)//
						.eq("order_status", Constant.ORDER_STATUS_4).eq("transfer_stauts", Constant.TRANSFER_STAUTS_1));

		// 如果未退款不为空
		if (null != incomeAndNotRecord) {
			// 判断未退款中的总收入是否为空
			if(null == incomeAndNotRecord.getHistorySumIncome()){
				logger.error(ErrorCode.IsNullRetCode + "，当前历史总收入为 ：" + JSON.toJSONString(incomeAndNotRecord.getHistorySumIncome()), null);
			}else{
				historySumIncome = historySumIncome.add(incomeAndNotRecord.getHistorySumIncome());// 总收入
			}
			// 判断未退款中的历史总分成是否为空
			if(null == incomeAndNotRecord.getHistorySumPartion()){
				logger.error(ErrorCode.IsNullRetCode + "，当前历史总分成为：" + JSON.toJSONString(incomeAndNotRecord.getHistorySumPartion()), null);
			}else{				
				historySumPartion = historySumPartion.add(incomeAndNotRecord.getHistorySumPartion());// 平台分成
			}
			// 判断未退款中的合计是否为空
			if(null == incomeAndNotRecord.getTotal()){
				logger.error(ErrorCode.IsNullRetCode + "，当前合计为：" + JSON.toJSONString(incomeAndNotRecord.getTotal()), null);
			}else{				
				total = total.add(incomeAndNotRecord.getTotal()); // 合计
			}
		}
		// 已退款
		BfBusinessRecordDayVo incomeAndRecorded = bfBusinessRecordDayMapper
				.getIncomeAndRefunded(new EntityWrapper<Integer>().eq("shop_id", shopId)
						.eq("order_status", Constant.ORDER_STATUS_7).eq("transfer_stauts", Constant.TRANSFER_STAUTS_1));

		// 如果已退款为空
		if (null != incomeAndRecorded) {
			// 判断已退款的历史总收入
			if(null == incomeAndRecorded.getHistorySumIncome()){
				logger.error(ErrorCode.IsNullRetCode + "，当前历史总分成为：" + JSON.toJSONString(incomeAndRecorded.getHistorySumIncome()), null);
			}else{
				historySumIncome = historySumIncome.add(incomeAndRecorded.getHistorySumIncome());// 总收入				
			}
			// 判断已退款中总退款是否为空
			if(null == incomeAndRecorded.getHistorySumRefund()){
				logger.error(ErrorCode.IsNullRetCode + "，当前历史总分成为：" + JSON.toJSONString(incomeAndRecorded.getHistorySumRefund()), null);
			}else{
				historySumRefund = historySumRefund.add(incomeAndRecorded.getHistorySumRefund());				
			}
		}
		// 历史流水
		List<HistroySumRecordVo> histroySumRecordVos = bfBusinessRecordDayMapper
				.getHistorySumRecord(new EntityWrapper<Integer>().eq("shop_id", shopId));
		map.put("historySumIncome", historySumIncome); // 历史总收入
		map.put("historySumRefund", historySumRefund); // 历史退款
		map.put("historySumPartion", historySumPartion); // 平台分成
		map.put("total", total); // 总收入
		map.put("histroySumRecord", histroySumRecordVos);// 详情

		baseResult = BaseResult.success();
		// 返回查询的信息
		baseResult.setData(map);
		return baseResult;
	}

	/**
	 * 查看历史详情（日）
	 * 
	 * @param businessRecordDetailRequest
	 * @return
	 * @throws Exception
	 */
	public BaseResult getBusinessRecordDetail(BusinessRecordDetailRequest businessRecordDetailRequest,
			UserBaseInfoVo userVo) throws Exception {
		BaseResult baseResult = null;
		Map<String, Object> map = new HashMap<>();

		String phone = null;
		phone = userVo.getPhone();

		BfShop selectShop = new BfShop();
		selectShop.setPhone(phone);
		BfShop shop = bfShopMapper.selectOne(selectShop);
		if (shop == null) {
			logger.error(ErrorCode.IsNullRetCode + "，当前商店为：" + JSON.toJSONString(shop), null);
			return BaseResult.fail(ErrorCode.NullPointerExceptionRetInfo, ErrorCode.NullPointerExceptionRetCode);
		}
		// 获得年月日
		String appointDay = businessRecordDetailRequest.getOrderTime().substring(0, 10);
		SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd");
		Date date = sdf.parse(appointDay); // 转换成指定日期
		// 获得早上时间
		String morning = DateUtils.morning(date);
		// 获得晚上时间
		String night = DateUtils.night(date);

		// 历史流水（日）
		List<BfOrderVo> bfOrderVos = bfBusinessRecordDayMapper.getOrderDay(	new EntityWrapper<>().eq("shop_id", shop.getId()).ge("order_time", morning).le("order_time", night).orderBy("id", false));

		BigDecimal sumIncome = new BigDecimal(0); // 总收入
		BigDecimal sumRefund = new BigDecimal(0); // 退款
		BigDecimal sumPartion = new BigDecimal(0); // 平台
		BigDecimal total = new BigDecimal(0); // 合计

		// 未退款
		BfOrderVos bfOrderVosNotRefund = bfBusinessRecordDayMapper.getDayNotRefund(new EntityWrapper<>()
				.eq("order_status", Constant.ORDER_STATUS_4).ge("order_time", morning).le("order_time", night));
		// 未退款不为空
		if (null != bfOrderVosNotRefund) {
			// 判断未退款的总收入是否为空
			if(null == bfOrderVosNotRefund.getSumIncome()){
				logger.error(ErrorCode.IsNullRetCode + "，未退款中总收入为：" + JSON.toJSONString(bfOrderVosNotRefund.getSumIncome()), null);
			}else{
				sumIncome = sumIncome.add(bfOrderVosNotRefund.getSumIncome());				
			}
			
			// 判断平台总收入是否为空
			if(null == bfOrderVosNotRefund.getSumPartion()){
				logger.error(ErrorCode.IsNullRetCode + "，未退款中平台总收入为：" + JSON.toJSONString(bfOrderVosNotRefund.getSumPartion()), null);
			}else{
				sumPartion = sumPartion.add(bfOrderVosNotRefund.getSumPartion());				
			}
			
			// 判断未退款总计是否为空
			if(null == bfOrderVosNotRefund.getTotal()){
				logger.error(ErrorCode.IsNullRetCode + "，未退款的总计为：" + JSON.toJSONString(bfOrderVosNotRefund.getTotal()), null);
			}else{				
				total = total.add(bfOrderVosNotRefund.getTotal());
			}
		}
		// 已退款
		BfOrderVos bfOrderVosRefunded = bfBusinessRecordDayMapper.getDayNotRefund(new EntityWrapper<>()
				.eq("order_status", Constant.ORDER_STATUS_7).ge("order_time", morning).le("order_time", night));
		// 已退款不为空
		if (null != bfOrderVosRefunded) {
			// 已退款的总收入
			if(null == bfOrderVosRefunded.getSumIncome()){
				logger.error(ErrorCode.IsNullRetCode + "，已退款的总收入为：" + JSON.toJSONString(bfOrderVosRefunded.getSumIncome()), null);
			}else{				
				sumIncome = sumIncome.add(bfOrderVosRefunded.getSumIncome());
			}
			// 退款总计是否为空
			if(null == bfOrderVosRefunded.getSumRefund()){
				logger.error(ErrorCode.IsNullRetCode + "，退款总计为：" + JSON.toJSONString(bfOrderVosRefunded.getSumRefund()), null);
			}else{
				sumRefund = sumRefund.add(bfOrderVosRefunded.getSumRefund());				
			}
		}
		// 每天总收入
		map.put("sumIncome", sumIncome);
		// 每天退款
		map.put("sumRefund", sumRefund);
		// 每天平台分成
		map.put("sumPartion", sumPartion);
		// 合计
		map.put("total", total);
		// 订单
		map.put("Order", bfOrderVos);

		baseResult = BaseResult.success();
		// 返回查询的信息
		baseResult.setData(map);
		return baseResult;
	}

	/**
	 * 查看订单列表
	 * 
	 * @param orderListRequest
	 * @param userVo
	 * @return
	 */
	public BaseResult getOrderList(OrderListRequest orderListRequest, UserBaseInfoVo userVo) throws Exception {
		BaseResult baseResult = null;
		Map<String, Object> map = new HashMap<>();

		String phone = userVo.getPhone();

		BfShop selectShop = new BfShop();
		selectShop.setPhone(phone);
		BfShop shop = bfShopMapper.selectOne(selectShop);
		if (shop == null) {
			logger.error(ErrorCode.IsNullRetCode + "，当前商店为：" + JSON.toJSONString(shop), null);
			return BaseResult.fail(ErrorCode.NullPointerExceptionRetInfo, ErrorCode.NullPointerExceptionRetCode);
		}
		// 获得订单列表（通过商店id）
		List<BfOrdersVo> bfOrdersVos = bfOrderMapper.getOrderList( new EntityWrapper<>().eq("shop_id", shop.getId()).eq("order_status", orderListRequest.getOpType()).orderBy("id", false));

		map.put("Orders", bfOrdersVos);
		baseResult = BaseResult.success();
		// 返回查询的信息
		baseResult.setData(map);
		return baseResult;
	}

}