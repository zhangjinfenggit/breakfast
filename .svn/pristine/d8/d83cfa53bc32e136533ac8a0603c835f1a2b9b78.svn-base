package com.hmw.open.common.pay;

import java.io.IOException;
import java.io.InputStream;
import java.util.Date;
import java.util.HashMap;
import java.util.Map;
import java.util.Properties;

import org.apache.log4j.Logger;

public class WeiXinPay {
	
	public static final Logger logger = Logger.getLogger(WeiXinPay.class);
	/**
	 * 编码类型
	 */
	private static String charset = "UTF-8";
	
	
	
	
	/**
	 *  微信公众号预下单
	 */
	public String orderPre(String orderNo,String orderMoney,String orderName,String orderTitle,String openid) {

		Date date = new Date();
		Map<String, String> origMap = new HashMap<String, String>();
		// 基本参数
		origMap.put("Service", "mag_pub_sinm_pay");
		origMap.put("Version", "1.0");
		origMap.put("PartnerId", "200001320043"); //生产环境的测试商户号
		origMap.put("InputCharset", charset);
		origMap.put("TradeDate", ChanPay.getDateFormat("yyyyMMdd").format(date));
		origMap.put("TradeTime", ChanPay.getDateFormat("HHmmss").format(date));
		origMap.put("ReturnUrl", getProperties("wechat.pay.orderPre.returnUrl"));// 前台跳转url
		origMap.put("Memo", "备注");

		// 4.2.1.1. 公众号/服务窗确认支付 api 业务参数
		origMap.put("OutTradeNo", orderNo);//订单号
		origMap.put("MchId", "200001320043");//商户号
		//origMap.put("SubMchId", "334");//子商户标示id
		origMap.put("TradeType", "11");//交易类型（11即时12担保）
		origMap.put("AppId", getProperties("wechat.appid"));//微信标示
		origMap.put("BuyerPayCode", openid);//付方id
		//origMap.put("DeviceInfo","");
		origMap.put("Currency", "CNY");//币种
		origMap.put("TradeAmount", orderMoney);//交易金额
		//origMap.put("EnsureAmount", "0.01");//担保金额
		origMap.put("GoodsName", orderName);//商品名称
		//origMap.put("TradeMemo", "1111");//商品描述
		origMap.put("Subject",orderTitle);//订单标题
		origMap.put("OrderStartTime",ChanPay.getDateFormat("yyyyMMddHHmmss").format(date));//订单起始时间
		//origMap.put("OrderEndTime", "2231");//订单失效时间
		//origMap.put("LimitCreditPay", "2231");//限制信用卡
		//origMap.put("SplitList", "2231");//分账列表
		origMap.put("NotifyUrl",  getProperties("wechat.pay.orderPre.notifyUrl"));
		origMap.put("SpbillCreateIp", "59.45.169.9");
		String reString = gatewayPost(origMap, charset, getProperties("wechat.pay.merchant_private_key"));
		return reString;
	}
	
	/**
	 * 向测试服务器发送post请求
	 * 
	 * @param origMap
	 *            参数map
	 * @param charset
	 *            编码字符集
	 * @param MERCHANT_PRIVATE_KEY
	 *            私钥
	 */
	public String gatewayPost(Map<String, String> origMap, String charset,String MERCHANT_PRIVATE_KEY) {
		try {
			String urlStr = "https://pay.chanpay.com/mag-unify/gateway/receiveOrder.do?";
			Map<String, String> sPara =  ChanPay.buildRequestPara(origMap, "RSA",MERCHANT_PRIVATE_KEY, charset);
			logger.info(urlStr +  ChanPay.createLinkString(sPara, true));
			String resultString =  ChanPay.buildRequest(origMap, "RSA",MERCHANT_PRIVATE_KEY, charset, urlStr);
			logger.info("畅捷支付返回数据："+resultString);
			return resultString;
		} catch (Exception e) {
			System.out.println(e);
			return "";
		}
	}
	
	/**
	 * 从配置文件中获取模板id编号
	 * 
	 * @param templateIdName
	 *            配置文件中模板名称
	 * @return
	 * @throws IOException
	 */
	public String getProperties(String templateIdName) {
		InputStream in = getClass().getResourceAsStream("/config.properties");
		Properties p = new Properties();
		try {
			p.load(in);
		} catch (IOException e) {
			// TODO Auto-generated catch block
			logger.error("读取配置文件config.properties异常");
			e.printStackTrace();
		}
		return p.getProperty(templateIdName);

	}
	
}
