package com.hmw.open.common.msm;

import com.aliyuncs.DefaultAcsClient;
import com.aliyuncs.IAcsClient;
import com.aliyuncs.dysmsapi.model.v20170525.SendSmsRequest;
import com.aliyuncs.dysmsapi.model.v20170525.SendSmsResponse;
import com.aliyuncs.http.MethodType;
import com.aliyuncs.profile.DefaultProfile;
import com.aliyuncs.profile.IClientProfile;
import com.hmw.open.common.utils.StringUtil;

/**
 * 短信
 * @author dongcyu
 *
 */
public class MsmTool {
	
	
	private static String domain  = "dysmsapi.aliyuncs.com";
	private static String product = "Dysmsapi";
	private static String signName = "智慧校车";
	
	private static String accessKeyId = "LTAIVyTDKW7LSnZn";
	private static String accessKeySecret = "sdCGr2XqlYh3NaJXSqUHyIzmYiQhBA"; 
	
	public static enum msmType {password, loginAndRegister};//password 找回密码；registe注册验证

	/**
	 * 发送短息
	 * @param mobile 手机号
	 * @param msm 发送的内容
	 * @param type 类型 password 找回密码；registe注册验证
	 * @return 0：发送失败；1:成功；2、手机号码错误；3:内容不能为空
	 */
	public static int sendMsm(String mobile, String msm, MsmTool.msmType type){
		int f = 0;
		if(StringUtil.isPhone(true, mobile)){
			if( !StringUtil.isEmpty(msm) ){
				try {
					String tempCode = "";
					String templateParam = "";
					if(type == MsmTool.msmType.password){//密码找回
						tempCode = "SMS_89890425";
						templateParam = "{\"code\":\""+msm+"\"}";
					 }else if(type == MsmTool.msmType.loginAndRegister){//注册
						 tempCode = "SMS_89890426";
						 templateParam = "{\"code\":\""+msm+"\"}";
					 }
					//初始化ascClient,暂时不支持多region
					IClientProfile profile = DefaultProfile.getProfile("cn-hangzhou", accessKeyId, accessKeySecret);
					DefaultProfile.addEndpoint("cn-hangzhou", "cn-hangzhou", product, domain);
					IAcsClient acsClient = new DefaultAcsClient(profile);
					
					//POST请求
					 SendSmsRequest request = new SendSmsRequest();
					 request.setMethod(MethodType.POST);
					 request.setPhoneNumbers(mobile);
					 request.setSignName(signName);//签名
					 request.setTemplateCode(tempCode);//模板编码
					 request.setTemplateParam(templateParam);//模板参数
					 
					 SendSmsResponse sendSmsResponse = acsClient.getAcsResponse(request);
					 if(sendSmsResponse.getCode() != null && sendSmsResponse.getCode().equals("OK")) {
						 //请求成功
						 f = 1;
					 }
				} catch (Exception e) {
					f = 0;
				}
				
			}else{//内容为空
				f = 3;
			}
		}else{//手机号码校验失败
			f = 2 ;
		}
		return f;
	}
}
