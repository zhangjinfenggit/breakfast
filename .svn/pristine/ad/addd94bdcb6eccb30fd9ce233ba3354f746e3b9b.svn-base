$(function () {

    //获取店铺信息
    var shopInfos = JSON.parse(sessionStorage.getItem('sessionShopInfo'));
    $('.shopName').text(shopInfos.shopName)
    $('.shopAddress').text(shopInfos.shopAddress);

    //订单编号
    var orderNo = GetQueryString("orderNo");
    //商品列表
    $.ajax({
        type: "post",
        headers: setHeader,
        url: "http://" + ip + "/breakfastApi/weixin/queryOrderDetail",
        async: true,
        data: JSON.stringify({"orderNo": orderNo}),
        dataType: "json",
        success: function (result) {
            if (result.retCode == "000000") {
                var list = result.data;
                var str1 = "";	//单品符串
                var str2 = "";	//套餐字符串
                var foodsList =  JSON.parse(list.orderDetail);
                sessionStorage.setItem("orderDetail",list.orderDetail);    //存订单信息

                var singleList = foodsList.singleProductList;
                var packageList = foodsList.packProductList;
                if (singleList && singleList.length > 0) {
                    for (var i = 0; i < singleList.length; i++) {
                        str1 += '<li>\
									<p>\
										<span>' + singleList[i].name + '</span><span>x' + singleList[i].amount + '</span>\
										<span>¥<u class="price">' + singleList[i].totalMoney + '</u></span>\
									</p>\
								</li>'
                    }
                }
                if (packageList && packageList.length > 0) {
                    for (var i = 0; i < packageList.length; i++) {
                        var str22 = '';
                        var packageListSingle = packageList[i].singleProductList; //套餐里的单品
                        for (var x = 0; x < packageListSingle.length; x++) {
                            str22 += '<li>' + packageListSingle[i].name + 'x' + packageListSingle[i].amount + '</li>'
                        }
                        str2 += '<li>\
									<p>\
										<span>' + singleList[i].name + '</span><span>x' + singleList[i].amount + '</span>\
										<span>¥<u class="price">' + singleList[i].totalMoney + '</u></span>\
									</p>\
									<ul>' + str22 + '</ul>\
								</li>'
                    }
                }
                $("#orderDetail").html(str1 + str2);
                $('.totalMoney').text(list.orderMoney);
                //优惠券抵扣金额
                getCoupon(list.orderMoney);

            } else {
                setTimeoutAlert(result.retMsg);
            }
        }
    })

    //可用优惠券
    function getCoupon(allPrice) {
        $.ajax({
            type:"post",
            headers:setHeader,
            url:"http://"+ip+"/breakfastApi/weixin/availableCoupon",
            async:false,
            data:JSON.stringify({ordersMoney:allPrice}),
            dataType:"json",
            success:function(result){
                if(result.retCode == "000000"){
                    var list = result.data;
                    var couponMoney = list[0].couponMoney;
                    var couponStr = '';
                    $('.coupon_deduction').text('-¥'+couponMoney); //页面加载完显示一张可用的优惠券金额
                    for(var i=0;i<list.length;i++){
                        couponStr += "<li class='item'>\
								<img src='images/coupon.png' alt='' class='coupon'>\
								<div class='cou_desc'>\
									<p class='cou_price'>¥"+list[i].couponMoney+"</p>\
									<p>"+list[i].couponName+"</p>\
									<span>限"+list[i].overdueTime+"日前使用</span>\
									<span>使用此劵可抵扣"+list[i].couponMoney+"元早餐费用</span>\
								</div>\
								<img src='images/current.png' alt='' class='current'>\
							</li>";
                    }
                    needMoney(allPrice,couponMoney);//小计
                    $('.coupon_list').html(couponStr);
                    $('.coupon_list .item').eq(0).addClass('cur');//默认选中第一个优惠券

                }else{
                    setTimeoutAlert(result.retMsg);
                }
            }
        });
    }

    //优惠券弹窗
    $('.coupon_deduction').on('click', function () {
        $('.order_confirm').hide();
        $('.dialog').show();
        chooseCoupon();
    })


    // 进入优惠券弹窗，选择优惠券时
    function chooseCoupon(){
        $('.coupon_list .item').on('click', function () {
            var _this = $(this);
            var money = _this.find('.cou_price').text();  //所选择优惠券的面额
            var allPrice =  parseFloat($('.totalMoney').text());   //订单总价，未使用优惠券前
            var couponMoney =  parseFloat(money.slice(1));  //所选择优惠券的面额

            _this.addClass('cur').siblings().removeClass('cur');

            setTimeout(function () {    //优惠券页面的显示隐藏
                $('.order_confirm').show();
                $('.dialog').hide();
            },500);

            $('.coupon_deduction').text('-'+money); //优惠券抵扣值显示
            needMoney(allPrice,couponMoney);//小计

        })
    }
    //小计
    function needMoney(allPrice,couponMoney){
        var needPayMoney = allPrice - couponMoney;  //小计
        $('.order_sum').text(needPayMoney); //小计
    }

});