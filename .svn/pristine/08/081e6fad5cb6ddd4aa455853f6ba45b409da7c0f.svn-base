$(function () {


    isClick();
    //店铺id
    var shopId = GetQueryString('shopId');
    //请求店铺商品
    $.ajax({
        type: "post",
        headers: setHeader,
        async: false,
        url: "http://" + ip + "/breakfastApi/weixin/queryProduct",
        data: JSON.stringify({shopId: shopId}),
        dataType: 'json',
        success: function (result) {
            if (result.retCode == '000000') {
                var singeProductList = result.data.singeProductList;
                var packageProductList = result.data.packageProductList;
                var str = '';
                for (var i = 0; i < singeProductList.length; i++) { //单品
                    str += '\
                        <li>\
                            <img src="images/bao_pic.png" alt="" class="pro_pic">\
                            <div class="meal_box">\
                                <h2>' + singeProductList[i].singleName + '</h2>\
                            </div>\
                            <div class="sel_box">\
                                <p>¥<u style="display:none;" class="meal_price">0</u><u class="unit_price">' + singeProductList[i].singleMoney + '</u></p>\
                                <div>\
                                    <span class="min"><img src="images/min.png" alt=""></span>\
                                    <span class="meal_num" data-type="1" data-id="'+singeProductList[i].id+'"  data-money="'+singeProductList[i].singleMoney+'">0</span>\
                                    <span class="add"><img src="images/add.png" alt=""></span>\
                                </div>\
                            </div>\
                        </li>'
                }
                for (var i = 0; i < packageProductList.length; i++) {   //套餐
                    var packageList = packageProductList[i].bfSingeProductList;
                    var str2 = '';
                    for (var x = 0; x < packageList.length; x++) {
                        str2 += '<p>' + packageList[x].singleName + 'x' + packageList[x].singleAmount + '</p>'
                    }
                    str += '\
                        <li>\
                            <img src="images/bao_pic.png" alt="" class="pro_pic">\
                            <div class="meal_box">\
                                <h2>' + packageProductList[i].packageName + '</h2>' + str2 + '\
                            </div>\
                            <div class="sel_box">\
                                <p>¥<u style="display:none;" class="meal_price">0</u><u class="unit_price">' + packageProductList[i].packageMoney + '</u></p>\
                                <div>\
                                    <span class="min"><img src="images/min.png" alt=""></span>\
                                    <span class="meal_num" data-type="2" data-id="'+packageProductList[i].id +'" data-money="'+packageProductList[i].packageMoney+'">0</span>\
                                    <span class="add"><img src="images/add.png" alt=""></span>\
                                </div>\
                            </div>\
                        </li>';
                }
                $('.meal_list').empty().html(str);

            } else {
                setTimeoutAlert(result.retMsg);
            }
        }
    })
    //获取店铺信息
    var shopInfo = JSON.parse(sessionStorage.getItem("sessionShopInfo"));
    $(".shopImg").attr("src",shopInfo.shopImg)
    $(".shopName").text(shopInfo.shopName)
    $(".shopAddress").text(shopInfo.shopAddress);


    //判断是否可以下单
    function isClick() {
        var allPrice = parseFloat($('.all_price').text());
        if (allPrice <= 0) {  //价格>0才可以下单
            $('#toOrder').addClass('hui')
            $('#toOrder').attr('disabled', true);
        } else {
            $('#toOrder').removeClass('hui')
            $('#toOrder').attr('disabled', false);
        }
    }
    //缓存已选商品
   // var orderDetail = JSON.parse(sessionStorage.getItem("orderDetail"))
   // var singleProductList = orderDetail.singleProductList;
   // var packProductList = orderDetail.packProductList;
   // $.each(singleProductList, function (i, val) {
   //
   // })

    //下单
    toOrder()
    function toOrder() {
        $('#toOrder').on('click', function () {
            var amount = $('.meal_num');
            var allPrice = parseFloat($('.all_price').text()); //总金额
            var phone = sessionStorage.getItem('phone');
            var sessionAddress = JSON.parse(localStorage.getItem('setAddress')); //

            var takeAddress = ""; //取餐地址
            $.each(sessionAddress, function (i, val) {
                takeAddress += val;
            })

            var singleList = [];    //单品id和数量
            var packageList = [];   //套餐id和数量
            for (var i = 0; i < amount.length; i++) {
                var item = amount.eq(i);
                if (parseInt(item.html()) > 0) {
                    if (item.attr('data-type') == 1) {
                        var obj1 = {"id": item.attr('data-id'), "amount": item.html(),"singleMoney":item.attr('data-money')};
                        singleList.push(obj1);
                    } else if (item.attr('data-type') == 2) {
                        var obj2 = {"id": item.attr('data-id'), "amount": item.html(),"packageMoney":item.attr('data-money')};
                        packageList.push(obj2);
                    }
                }
            }
            var _data = {
                "shopId": shopId,
                "totalMoney": allPrice,
                "singleProductList": singleList,
                "packProductList": packageList,
            }
            toOrderAjax(_data);
        })
    }
    //下单接口数据
    function toOrderAjax(data){
        $.ajax({
            type: "post",
            headers: setHeader,
            url: "http://" + ip + "/breakfastApi/weixin/saveOrder",
            data: JSON.stringify(data),
            dataType: 'json',
            success: function (result) {
                if (result.retCode == '000000') {
                     window.location.href = "order_confirm.html?orderNo=" + result.data;
                    //缓存店铺地址
                    var shopInfo = {
                        shopName:$('#shop').text(),
                        shopAdress:$('.shopAddress').text()
                    }
                    sessionStorage.setItem("key",shopInfo);

                } else {
                    setTimeoutAlert(result.retMsg);
                }
            }
        });
    }

    //选择商品数量增减
    $('.add').on("click", function () {
        $(this).siblings('.meal_num').css('display', 'block');
        $(this).siblings('.min').css('display', 'block');
        var val = parseInt($(this).siblings('.meal_num').html()) + 1;
        $(this).siblings('.meal_num').html(val);
        // 数量
        var meal_num = $(this).siblings('.meal_num').html();
        // 单价
        var unit_price = $(this).parent().siblings().find('.unit_price').html();
        // 计算
        var reckon = parseInt(meal_num * unit_price);
        $(this).parent().siblings().find('.meal_price').html(reckon);
        all_sum();
        isClick();
    })
    $('.min').click(function () {
        var val = parseInt($(this).siblings('.meal_num').html()) - 1;
        if (parseInt(val) < 1) {
            val = 0;
            $(this).siblings('.meal_num').css('display', 'none');
            $(this).css('display', 'none');
        }
        $(this).siblings('.meal_num').html(val);
        // 数量
        var meal_num = $(this).siblings('.meal_num').html();
        // 单价
        var unit_price = $(this).parent().siblings().find('.unit_price').html();
        // 计算
        var reckon = parseInt(meal_num * unit_price);
        $(this).parent().siblings().find('.meal_price').html(reckon);
        all_sum();
        isClick();
    })
})

function all_sum(){
    var order = 0;
    $('.meal_price').each(function(){
        //循环遍历总价
        order += parseInt($(this).html());
    })
    //修改总金额
    $('.all_price').html(order);
}
